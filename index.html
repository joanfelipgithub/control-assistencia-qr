<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Control Asistencia">
    <meta name="theme-color" content="#075e54">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <title>Control de Asistencia QR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }
        
        .header { padding: 20px; background: rgba(0,0,0,0.3); text-align: center; backdrop-filter: blur(10px); }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header .fecha { font-size: 14px; opacity: 0.9; }
        .header .device-id { font-size: 11px; opacity: 0.7; margin-top: 5px; font-family: monospace; }
        
        .main-content { flex: 1; padding: 20px; padding-bottom: 100px; overflow-y: auto; }
        
        .scanner-box {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        /* SCANNER WINDOW STYLING */
        #reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            position: relative; /* Needed for laser animation */
            border: 4px solid #667eea;
            min-height: 250px;
        }

        #reader video {
            width: 100% !important;
            height: auto !important;
            object-fit: cover !important;
        }

        /* LASER ANIMATION EFFECT */
        #reader:not(.hidden)::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 0, 0, 0.7);
            box-shadow: 0 0 15px 2px rgba(255, 0, 0, 0.8);
            z-index: 10;
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% { top: 0%; }
            50% { top: 100%; }
            100% { top: 0%; }
        }
        
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 15px; }
        .btn-primary { background: #25d366; color: white; }
        .btn-primary:active { transform: scale(0.98); background: #1da851; }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #ff6b6b; color: white; }
        .hidden { display: none !important; }
        
        .lista-box { background: white; border-radius: 16px; padding: 20px; color: #333; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .lista-box h2 { color: #667eea; margin-bottom: 15px; font-size: 20px; }
        
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-item { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; }
        
        .estudiante-item { padding: 15px; background: #f8f9fa; border-left: 4px solid #25d366; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .btn-eliminar { background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        
        .controles-footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); display: flex; gap: 10px; }
        .btn-footer { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-limpiar { background: #ff6b6b; color: white; }
        .btn-exportar { background: #25d366; color: white; }
        .btn-footer:disabled { background: #ccc; cursor: not-allowed; }
        
        .notificacion { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 15px 25px; border-radius: 12px; display: none; z-index: 9999; }
        .notificacion.show { display: block; }
        .notificacion.success { background: #25d366; }
        .notificacion.error { background: #ff6b6b; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 500px; width: 100%; color: #333; }
        .archivo-contenido { background: #eee; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre; margin: 15px 0; max-height: 200px; overflow-y: auto; }
        
        .setup-modal { background: white; color: #333; padding: 25px; border-radius: 16px; max-width: 400px; text-align: center; }
        .setup-modal h2 { color: #667eea; margin-bottom: 15px; }
        .setup-modal input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .device-info { background: #f0f0f0; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Control de Asistencia</h1>
        <div class="fecha" id="fecha-actual"></div>
        <div class="device-id" id="device-id-display"></div>
    </div>
    
    <div class="main-content">
        <div class="scanner-box">
            <div id="reader" class="hidden"></div>
            <button id="btn-iniciar" class="btn btn-primary">üì∑ Iniciar Esc√°ner</button>
            <button id="btn-detener" class="btn btn-secondary hidden">‚èπÔ∏è Detener Esc√°ner</button>
        </div>
        
        <div class="lista-box">
            <h2>‚úÖ Estudiantes Registrados</h2>
            <div class="stats">
                <div class="stat-item"><div class="stat-number" id="stat-presentes">0</div><div class="stat-label">Presentes</div></div>
                <div class="stat-item"><div class="stat-number" id="stat-total">8</div><div class="stat-label">Total</div></div>
            </div>
            <div id="lista-estudiantes"></div>
        </div>
    </div>
    
    <div class="controles-footer">
        <button id="btn-limpiar" class="btn-footer btn-limpiar" disabled>üóëÔ∏è Limpiar</button>
        <button id="btn-exportar" class="btn-footer btn-exportar" disabled>üì§ Exportar</button>
    </div>

    <div class="notificacion" id="notificacion"></div>

    <!-- Modal para configurar nombre de estudiante (primera vez) -->
    <div class="modal" id="modal-setup">
        <div class="setup-modal">
            <h2>üëã Configuraci√≥n Inicial</h2>
            <p style="margin-bottom: 15px;">Introduce tu nombre para identificar este dispositivo:</p>
            <input type="text" id="input-nombre-estudiante" placeholder="Ej: Jordi Casals" autocomplete="off">
            <div class="device-info" id="device-info-preview"></div>
            <button class="btn btn-primary" onclick="guardarNombreEstudiante()">‚úÖ Guardar</button>
        </div>
    </div>

    <div class="modal" id="modal-exportar">
        <div class="modal-content">
            <h3 id="nombre-archivo"></h3>
            <div class="archivo-contenido" id="contenido-archivo"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="descargarArchivo()">‚¨áÔ∏è Descargar</button>
                <button class="btn btn-primary" style="background:#25d366" onclick="compartirWhatsApp()">üí¨ WhatsApp</button>
                <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const ESTUDIANTES_DB = {
            '4810': 'Jordi Casals i Guiu', '4815': 'Laia Font i Soler',
            '4820': 'Marc Rovira i Costa', '4825': 'Eul√†lia Serra i Vernet',
            '4830': 'Pau Mart√≠ i Bosch', '4835': 'Mireia Vilalta i Grau',
            '4840': 'Andreu Camps i Ribes', '4845': 'Aina Torrent i Pag√®s'
        };

        let html5QrcodeScanner = null;
        let registrados = [];
        const beep = new Audio('data:audio/wav;base64,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');
        const reader = document.getElementById('reader');
        const btnIniciar = document.getElementById('btn-iniciar');
        const btnDetener = document.getElementById('btn-detener');
        const listaContainer = document.getElementById('lista-estudiantes');
        const statPresentes = document.getElementById('stat-presentes');
        const btnLimpiar = document.getElementById('btn-limpiar');
        const btnExportar = document.getElementById('btn-exportar');
        const modalExportar = document.getElementById('modal-exportar');
        const modalSetup = document.getElementById('modal-setup');
        const notificacion = document.getElementById('notificacion');

        // DEVICE ID MANAGEMENT
        function generarDeviceID() {
            // Genera un ID √∫nico basado en m√∫ltiples factores del navegador
            const navegadorInfo = navigator.userAgent + navigator.language + screen.width + screen.height;
            let hash = 0;
            for (let i = 0; i < navegadorInfo.length; i++) {
                const char = navegadorInfo.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            // Combina con timestamp y random para mayor unicidad
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 5);
            return `D${Math.abs(hash).toString(36).substr(0, 4)}-${timestamp.substr(-4)}${random}`.toUpperCase();
        }

        function obtenerDeviceID() {
            let deviceID = localStorage.getItem('device-id');
            if (!deviceID) {
                deviceID = generarDeviceID();
                localStorage.setItem('device-id', deviceID);
            }
            return deviceID;
        }

        function obtenerNombreEstudiante() {
            return localStorage.getItem('student-name') || null;
        }

        function guardarNombreEstudiante() {
            const nombre = document.getElementById('input-nombre-estudiante').value.trim();
            if (!nombre) {
                alert('Por favor introduce tu nombre');
                return;
            }
            
            localStorage.setItem('student-name', nombre);
            modalSetup.classList.remove('show');
            actualizarDisplayDeviceID();
            mostrarNotificacion('‚úÖ Dispositivo configurado: ' + nombre, 'success');
        }

        function actualizarDisplayDeviceID() {
            const deviceID = obtenerDeviceID();
            const nombreEstudiante = obtenerNombreEstudiante();
            const displayElement = document.getElementById('device-id-display');
            
            if (nombreEstudiante) {
                displayElement.textContent = `üì± ${nombreEstudiante} (ID: ${deviceID})`;
            } else {
                displayElement.textContent = `üì± ID: ${deviceID}`;
            }
        }

        function mostrarSetupSiNecesario() {
            if (!obtenerNombreEstudiante()) {
                const deviceID = obtenerDeviceID();
                document.getElementById('device-info-preview').textContent = `ID de dispositivo: ${deviceID}`;
                modalSetup.classList.add('show');
            }
        }

        function playBeep() { beep.play().catch(() => {}); }
        
        function init() {
            document.getElementById('fecha-actual').textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            actualizarDisplayDeviceID();
            cargarDatos();
            actualizarStats();
            mostrarSetupSiNecesario();
        }

        function guardarDatos() { localStorage.setItem('asistencia-registrados', JSON.stringify(registrados)); }
        function cargarDatos() { 
            const datos = localStorage.getItem('asistencia-registrados');
            if (datos) { registrados = JSON.parse(datos); actualizarLista(); }
        }

        btnIniciar.addEventListener('click', async function() {
            try {
                btnIniciar.disabled = true;
                btnIniciar.textContent = "‚åõ Iniciando...";

                // Force a 300ms delay to help iOS Safari "catch up" with the user gesture
                await new Promise(r => setTimeout(r, 300));

                html5QrcodeScanner = new Html5Qrcode("reader");
        
                // Start the scanner
                await html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: (w, h) => {
                            let size = Math.floor(Math.min(w, h) * 0.7);
                            return { width: size, height: size };
                        }
                    },
                    onScanSuccess
                );

                reader.classList.remove('hidden');
                btnIniciar.classList.add('hidden');
                btnDetener.classList.remove('hidden');
        
            } catch (err) {
                alert("Error de c√°mara: " + err);
                btnIniciar.disabled = false;
                btnIniciar.textContent = "üì∑ Iniciar Esc√°ner";
            }
        });

        btnDetener.addEventListener('click', async function() {
            if (html5QrcodeScanner) {
                try {
                    await html5QrcodeScanner.stop();
                    reader.classList.add('hidden');
                    btnDetener.classList.add('hidden');
                    btnIniciar.classList.remove('hidden');
                    btnIniciar.disabled = false;
                    btnIniciar.textContent = "üì∑ Iniciar Esc√°ner";
                    html5QrcodeScanner = null;
                    mostrarNotificacion('‚èπÔ∏è Esc√°ner detenido');
                } catch (err) { console.error(err); }
            }
        });

        function onScanSuccess(decodedText) {
            const id = decodedText.trim();
            if (!ESTUDIANTES_DB[id]) return;
            if (registrados.some(e => e.id === id)) {
                mostrarNotificacion('‚ö†Ô∏è Estudiante ya registrado', 'error');
                return;
            }
            
            playBeep();
            if (navigator.vibrate) navigator.vibrate(200);
            
            registrados.push({ id, nombre: ESTUDIANTES_DB[id], timestamp: new Date().toLocaleTimeString() });
            guardarDatos(); actualizarLista(); actualizarStats();
            mostrarNotificacion(`‚úÖ ${ESTUDIANTES_DB[id]} registrado`, 'success');
        }

        function onScanError(err) { /* Silent ignore scanning attempts */ }

        function actualizarLista() {
            listaContainer.innerHTML = registrados.length ? '' : 'Escanea un c√≥digo para empezar';
            registrados.forEach((est, i) => {
                const div = document.createElement('div');
                div.className = 'estudiante-item';
                div.innerHTML = `<div><b>${est.nombre}</b><br><small>ID: ${est.id} | ${est.timestamp}</small></div><button class="btn-eliminar" onclick="eliminarEstudiante(${i})">√ó</button>`;
                listaContainer.appendChild(div);
            });
            btnLimpiar.disabled = btnExportar.disabled = !registrados.length;
        }

        function actualizarStats() { statPresentes.textContent = registrados.length; }
        function eliminarEstudiante(i) { registrados.splice(i, 1); guardarDatos(); actualizarLista(); actualizarStats(); }
        function mostrarNotificacion(msg, tipo = '') {
            notificacion.textContent = msg;
            notificacion.className = 'notificacion show ' + tipo;
            setTimeout(() => notificacion.classList.remove('show'), 3000);
        }

        btnLimpiar.addEventListener('click', () => { if(confirm('¬øLimpiar lista?')) { registrados = []; guardarDatos(); actualizarLista(); actualizarStats(); }});
        
        btnExportar.addEventListener('click', () => {
            const deviceID = obtenerDeviceID();
            const nombreEstudiante = obtenerNombreEstudiante() || 'Unknown';
            const fecha = new Date();
            const fechaStr = fecha.toISOString().slice(0,10);
            const horaStr = fecha.toTimeString().slice(0,5).replace(':', '-');
            
            // Nuevo formato de nombre: Assist_DEVICEID_NOMBRE_FECHA_HORA.txt
            const nombreArchivo = `Assist_${deviceID}_${nombreEstudiante.replace(/\s+/g, '-')}_${fechaStr}_${horaStr}.txt`;
            
            // Incluir informaci√≥n del dispositivo en el contenido del archivo
            const headerInfo = `===========================================
CONTROL DE ASISTENCIA
===========================================
Fecha: ${fecha.toLocaleDateString('es-ES')}
Hora: ${fecha.toLocaleTimeString('es-ES')}
Dispositivo: ${deviceID}
Responsable: ${nombreEstudiante}
Total Presentes: ${registrados.length}
===========================================

LISTADO DE ASISTENCIA:
-------------------------------------------
`;
            
            const contenidoLista = registrados.map(e => `${e.timestamp} - ${e.id} - ${e.nombre}`).join('\n');
            const contenidoCompleto = headerInfo + contenidoLista;
            
            document.getElementById('nombre-archivo').textContent = nombreArchivo;
            document.getElementById('contenido-archivo').textContent = contenidoCompleto;
            modalExportar.classList.add('show');
        });

        function cerrarModal() { modalExportar.classList.remove('show'); }
        
        function descargarArchivo() {
            const blob = new Blob([document.getElementById('contenido-archivo').textContent], {type:'text/plain'});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = document.getElementById('nombre-archivo').textContent; 
            a.click();
        }

        // COMPARTIR POR WHATSAPP CON ARCHIVO ADJUNTO - VERSION MEJORADA
        async function compartirWhatsApp() {
            const contenido = document.getElementById('contenido-archivo').textContent;
            const nombreArchivo = document.getElementById('nombre-archivo').textContent;
            const deviceID = obtenerDeviceID();
            const nombreEstudiante = obtenerNombreEstudiante() || 'Usuario';
            const textoResumen = `üìã *Asistencia - ${nombreEstudiante}*\nüì± Dispositivo: ${deviceID}\nüìÖ ${new Date().toLocaleDateString()}\n\nTotal presentes: ${registrados.length}\n\nSe adjunta el listado detallado.`;

            // CAMBIO CLAVE: Verificar si el navegador soporta compartir archivos
            const puedeCompartirArchivos = navigator.canShare && navigator.canShare({ files: [new File(['test'], 'test.txt', { type: 'text/plain' })] });

            if (puedeCompartirArchivos) {
                try {
                    const file = new File([contenido], nombreArchivo, { type: 'text/plain' });
                    
                    await navigator.share({
                        title: nombreArchivo,
                        text: textoResumen,
                        files: [file]
                    });
                    
                    mostrarNotificacion('‚úÖ Archivo compartido', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') { // Si no es que el usuario cancel√≥
                        console.error("Error al compartir archivo:", err);
                        // Fallback a texto solamente
                        compartirSoloTexto(textoResumen, contenido);
                    }
                }
            } else {
                // El navegador NO soporta compartir archivos
                console.log("Este navegador no soporta compartir archivos");
                compartirSoloTexto(textoResumen, contenido);
            }
        }

        function compartirSoloTexto(textoResumen, contenido) {
            const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(textoResumen + '\n\n' + contenido)}`;
            window.open(url, '_blank');
            mostrarNotificacion('üì± WhatsApp (Solo texto)', 'success');
        }

        init();
    </script>
</body>
</html>
