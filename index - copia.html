<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Control Asistencia">
    <meta name="theme-color" content="#075e54">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <title>Control de Asistencia QR</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }
        
        .header { padding: 20px; background: rgba(0,0,0,0.3); text-align: center; backdrop-filter: blur(10px); }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header .fecha { font-size: 14px; opacity: 0.9; }
        
        .main-content { flex: 1; padding: 20px; padding-bottom: 100px; overflow-y: auto; }
        
        .scanner-box {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        /* SCANNER WINDOW STYLING */
        #reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            position: relative; /* Needed for laser animation */
            border: 4px solid #667eea;
            min-height: 250px;
        }

        #reader video {
            width: 100% !important;
            height: auto !important;
            object-fit: cover !important;
        }

        /* LASER ANIMATION EFFECT */
        #reader:not(.hidden)::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 0, 0, 0.7);
            box-shadow: 0 0 15px 2px rgba(255, 0, 0, 0.8);
            z-index: 10;
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% { top: 0%; }
            50% { top: 100%; }
            100% { top: 0%; }
        }
        
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 15px; }
        .btn-primary { background: #25d366; color: white; }
        .btn-primary:active { transform: scale(0.98); background: #1da851; }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #ff6b6b; color: white; }
        .hidden { display: none !important; }
        
        .lista-box { background: white; border-radius: 16px; padding: 20px; color: #333; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .lista-box h2 { color: #667eea; margin-bottom: 15px; font-size: 20px; }
        
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-item { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; }
        
        .estudiante-item { padding: 15px; background: #f8f9fa; border-left: 4px solid #25d366; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .btn-eliminar { background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        
        .controles-footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); display: flex; gap: 10px; }
        .btn-footer { flex: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-limpiar { background: #ff6b6b; color: white; }
        .btn-exportar { background: #25d366; color: white; }
        .btn-footer:disabled { background: #ccc; cursor: not-allowed; }
        
        .notificacion { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 15px 25px; border-radius: 12px; display: none; z-index: 9999; }
        .notificacion.show { display: block; }
        .notificacion.success { background: #25d366; }
        .notificacion.error { background: #ff6b6b; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 500px; width: 100%; color: #333; }
        .archivo-contenido { background: #eee; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre; margin: 15px 0; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Control de Asistencia</h1>
        <div class="fecha" id="fecha-actual"></div>
    </div>
    
    <div class="main-content">
        <div class="scanner-box">
            <div id="reader" class="hidden"></div>
            <button id="btn-iniciar" class="btn btn-primary">üì∑ Iniciar Esc√°ner</button>
            <button id="btn-detener" class="btn btn-secondary hidden">‚èπÔ∏è Detener Esc√°ner</button>
        </div>
        
        <div class="lista-box">
            <h2>‚úÖ Estudiantes Registrados</h2>
            <div class="stats">
                <div class="stat-item"><div class="stat-number" id="stat-presentes">0</div><div class="stat-label">Presentes</div></div>
                <div class="stat-item"><div class="stat-number" id="stat-total">8</div><div class="stat-label">Total</div></div>
            </div>
            <div id="lista-estudiantes"></div>
        </div>
    </div>
    
    <div class="controles-footer">
        <button id="btn-limpiar" class="btn-footer btn-limpiar" disabled>üóëÔ∏è Limpiar</button>
        <button id="btn-exportar" class="btn-footer btn-exportar" disabled>üì§ Exportar</button>
    </div>

    <div class="notificacion" id="notificacion"></div>

    <div class="modal" id="modal-exportar">
        <div class="modal-content">
            <h3 id="nombre-archivo"></h3>
            <div class="archivo-contenido" id="contenido-archivo"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="descargarArchivo()">‚¨áÔ∏è Descargar</button>
                <button class="btn btn-primary" style="background:#25d366" onclick="compartirWhatsApp()">üí¨ WhatsApp</button>
                <button class="btn btn-secondary" onclick="cerrarModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const ESTUDIANTES_DB = { '4810': 'Jordi Casals i Guiu', '4815': 'Laia Font i Soler', '4820': 'Marc Rovira i Costa', '4825': 'Eul√†lia Serra i Vernet', '4830': 'Pau Mart√≠ i Bosch', '4835': 'Mireia Vilalta i Grau', '4840': 'Andreu Camps i Ribes', '4845': 'Aina Torrent i Pag√®s' };
        let registrados = [];
        let html5QrcodeScanner = null;
        
        // Audio Setup
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = "sine"; osc.frequency.value = 880;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        const btnIniciar = document.getElementById('btn-iniciar');
        const btnDetener = document.getElementById('btn-detener');
        const reader = document.getElementById('reader');
        const listaContainer = document.getElementById('lista-estudiantes');
        const statPresentes = document.getElementById('stat-presentes');
        const btnLimpiar = document.getElementById('btn-limpiar');
        const btnExportar = document.getElementById('btn-exportar');
        const modalExportar = document.getElementById('modal-exportar');
        const notificacion = document.getElementById('notificacion');

        function init() {
            document.getElementById('fecha-actual').textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            cargarDatos();
            actualizarStats();
        }

        function guardarDatos() { localStorage.setItem('asistencia-registrados', JSON.stringify(registrados)); }
        function cargarDatos() { 
            const datos = localStorage.getItem('asistencia-registrados');
            if (datos) { registrados = JSON.parse(datos); actualizarLista(); }
        }

        btnIniciar.addEventListener('click', async function() {
            try {
                btnIniciar.disabled = true;
                btnIniciar.textContent = "‚åõ Iniciando...";

                // Force a 300ms delay to help iOS Safari "catch up" with the user gesture
                await new Promise(r => setTimeout(r, 300));

                html5QrcodeScanner = new Html5Qrcode("reader");
        
                // Start the scanner
                await html5QrcodeScanner.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: (w, h) => {
                            let size = Math.floor(Math.min(w, h) * 0.7);
                            return { width: size, height: size };
                        }
                    },
                    onScanSuccess
                );

                reader.classList.remove('hidden');
                btnIniciar.classList.add('hidden');
                btnDetener.classList.remove('hidden');
        
            } catch (err) {
                alert("Error de c√°mara: " + err); // Use alert to see the error on iPhone
                btnIniciar.disabled = false;
                btnIniciar.textContent = "üì∑ Iniciar Esc√°ner";
            }
        });

        btnDetener.addEventListener('click', async function() {
            if (html5QrcodeScanner) {
                try {
                    await html5QrcodeScanner.stop();
                    reader.classList.add('hidden');
                    btnDetener.classList.add('hidden');
                    btnIniciar.classList.remove('hidden');
                    btnIniciar.disabled = false;
                    btnIniciar.textContent = "üì∑ Iniciar Esc√°ner";
                    html5QrcodeScanner = null;
                    mostrarNotificacion('‚èπÔ∏è Esc√°ner detenido');
                } catch (err) { console.error(err); }
            }
        });

        function onScanSuccess(decodedText) {
            const id = decodedText.trim();
            if (!ESTUDIANTES_DB[id]) return;
            if (registrados.some(e => e.id === id)) {
                mostrarNotificacion('‚ö†Ô∏è Estudiante ya registrado', 'error');
                return;
            }
            
            playBeep();
            if (navigator.vibrate) navigator.vibrate(200);
            
            registrados.push({ id, nombre: ESTUDIANTES_DB[id], timestamp: new Date().toLocaleTimeString() });
            guardarDatos(); actualizarLista(); actualizarStats();
            mostrarNotificacion(`‚úÖ ${ESTUDIANTES_DB[id]} registrado`, 'success');
        }

        function onScanError(err) { /* Silent ignore scanning attempts */ }

        function actualizarLista() {
            listaContainer.innerHTML = registrados.length ? '' : 'Escanea un c√≥digo para empezar';
            registrados.forEach((est, i) => {
                const div = document.createElement('div');
                div.className = 'estudiante-item';
                div.innerHTML = `<div><b>${est.nombre}</b><br><small>ID: ${est.id} | ${est.timestamp}</small></div><button class="btn-eliminar" onclick="eliminarEstudiante(${i})">√ó</button>`;
                listaContainer.appendChild(div);
            });
            btnLimpiar.disabled = btnExportar.disabled = !registrados.length;
        }

        function actualizarStats() { statPresentes.textContent = registrados.length; }
        function eliminarEstudiante(i) { registrados.splice(i, 1); guardarDatos(); actualizarLista(); actualizarStats(); }
        function mostrarNotificacion(msg, tipo = '') {
            notificacion.textContent = msg;
            notificacion.className = 'notificacion show ' + tipo;
            setTimeout(() => notificacion.classList.remove('show'), 3000);
        }

        btnLimpiar.addEventListener('click', () => { if(confirm('¬øLimpiar lista?')) { registrados = []; guardarDatos(); actualizarLista(); actualizarStats(); }});
        btnExportar.addEventListener('click', () => {
            const nombre = `Assist_${new Date().toISOString().slice(0,10)}.txt`;
            document.getElementById('nombre-archivo').textContent = nombre;
            document.getElementById('contenido-archivo').textContent = registrados.map(e => `${e.timestamp} - ${e.id} - ${e.nombre}`).join('\n');
            modalExportar.classList.add('show');
        });

        function cerrarModal() { modalExportar.classList.remove('show'); }
        function descargarArchivo() {
            const blob = new Blob([document.getElementById('contenido-archivo').textContent], {type:'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = document.getElementById('nombre-archivo').textContent; a.click();
        }

        function compartirWhatsApp() {
            const msg = `üìã *Asistencia*\n\n${document.getElementById('contenido-archivo').textContent}`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
        }

        init();
    </script>
</body>
</html>